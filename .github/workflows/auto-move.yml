name: Auto Move Problems

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  move:
    if: github.repository_owner != 'algo-gongbu'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Merge platform folders safely
        run: |
          TARGET=${{ vars.BAEKJOON_ID }}

          # ---------------------------
          # 1️⃣ BAEKJOON_ID 검증
          # ---------------------------
          if [ -z "$TARGET" ]; then
            echo "Error: BAEKJOON_ID variable is not set."
            exit 1
          fi

          if [ ! -d "$TARGET" ]; then
            echo "Error: Target folder $TARGET does not exist!"
            exit 1
          fi

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          MOVED=false

          # ---------------------------
          # 2️⃣ 처리할 플랫폼 목록
          # ---------------------------
          PLATFORMS=("백준" "프로그래머스")

          for PLATFORM in "${PLATFORMS[@]}"; do
            if [ -d "$PLATFORM" ]; then
              echo "Moving $PLATFORM folder..."

              mkdir -p "$TARGET/$PLATFORM"

              # 안전 병합
              rsync -av --remove-source-files "$PLATFORM/" "$TARGET/$PLATFORM/"

              rm -rf "$PLATFORM"

              MOVED=true
            fi
          done

          # ---------------------------
          # 3️⃣ 변경사항 커밋 및 푸시
          # ---------------------------
          if [ "$MOVED" = true ]; then
            git add .
            git commit -m "auto: merge solved problems into $TARGET folder" || echo "No changes"
            
            # 원격 저장소의 최신 상태를 가져와 Rebase 수행
            git pull --rebase origin main
            
            git push
          else
            echo "No platform folders to move."
          fi
